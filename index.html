<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shark Boy '72: Chrono-Link</title>
    <style>
        :root { --orange: #ff8c00; --neon-blue: #00f2ff; --pool-blue: #0077be; }
        body { margin: 0; background: #000; color: white; font-family: 'Arial Black', sans-serif; overflow: hidden; touch-action: none; }
        
        .screen { width: 100vw; height: 100vh; display: none; position: absolute; top: 0; left: 0; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        
        #story-screen { background: radial-gradient(circle, #001a33 0%, #000 100%); font-family: monospace; color: var(--neon-blue); }
        .dna-box { border: 1px solid var(--neon-blue); padding: 20px; text-align: left; background: rgba(0,0,0,0.5); max-width: 500px; }
        .shark-flex { font-size: 120px; margin: 20px 0; animation: flex 1s ease-in-out infinite; }
        @keyframes flex { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        #calibration-screen { background: radial-gradient(circle, #1a0033 0%, #000 100%); font-family: monospace; color: var(--neon-blue); }
        .cal-status { font-size: 1.5rem; margin: 20px 0; color: yellow; }
        .cal-complete { color: lime !important; }

        #menu { background: var(--orange); }
        .btn { padding: 10px; margin: 4px; border: none; border-radius: 8px; background: white; color: var(--orange); font-size: 0.9rem; font-weight: bold; width: 90%; max-width: 400px; box-shadow: 0 4px #cc7000; cursor: pointer; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px #cc7000; }
        
        #hud { position: absolute; top: 10px; width: 100%; z-index: 10; pointer-events: none; }
        #stopwatch { background: #111; border: 3px solid #444; border-radius: 8px; padding: 8px; color: #f00; font-size: 2.2rem; font-family: monospace; }
        #legend-name { background: rgba(0,0,0,0.7); font-size: 0.9rem; padding: 3px 10px; border-radius: 10px; margin-top: 5px; display: inline-block; }
        
        #controls { position: absolute; bottom: 0; width: 100%; height: 35%; display: grid; gap: 10px; padding: 15px; box-sizing: border-box; background: rgba(0,0,0,0.8); }
        
        .controls-freestyle { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .swim-btn { background: rgba(255,255,255,0.1); border: 2px solid white; border-radius: 12px; color: white; transition: background 0.1s, box-shadow 0.1s; position: relative; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .active-btn { background: var(--neon-blue) !important; color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        .breathe-btn { grid-column: span 2; }
        
        .controls-butterfly { grid-template-columns: 1fr 1fr; grid-template-rows: 2fr 1fr; }
        .tilt-zone { grid-column: span 2; background: rgba(255,140,0,0.2); border: 3px dashed white; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-direction: column; }
        
        .controls-backstroke { grid-template-columns: 1fr 1fr; grid-template-rows: 2fr 1fr; }
        .rock-zone { grid-column: span 2; background: rgba(100,100,255,0.2); border: 3px dashed white; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        
        .controls-breaststroke { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; }
        .slider-container { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .arm-slider { -webkit-appearance: none; width: 80%; height: 200px; background: linear-gradient(to top, #00f2ff, #ff8c00); writing-mode: bt-lr; -webkit-writing-mode: bt-lr; transform: rotate(270deg); cursor: pointer; border-radius: 10px; }
        .arm-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 50px; height: 50px; background: white; border-radius: 50%; cursor: pointer; border: 3px solid #000; }
        .arm-slider::-moz-range-thumb { width: 50px; height: 50px; background: white; border-radius: 50%; cursor: pointer; border: 3px solid #000; }
        
        #cramp-msg { position: absolute; top: 45%; width: 100%; color: red; font-size: 3.5rem; display: none; z-index: 100; text-shadow: 2px 2px #000; }
        #win-lab { display: none; width: 100%; height: 100%; background: #001a33; border: 2px solid var(--neon-blue); align-items: center; justify-content: center; flex-direction: column; }
        
        .legend-portrait { width: 200px; height: 200px; border-radius: 10px; border: 3px solid var(--orange); background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%); display: flex; align-items: center; justify-content: center; font-size: 80px; margin: 20px auto; box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        
        #photo-screen { background: var(--orange); }
        #camera-video { max-width: 90%; max-height: 50vh; border: 3px solid var(--neon-blue); border-radius: 10px; }
        #photo-canvas { max-width: 90%; max-height: 70vh; border: 3px solid #000; margin: 10px 0; }
        .hidden { display: none !important; }
    </style>
</head>
<body onload="init()">

    <div id="story-screen" class="screen">
        <div class="shark-flex">ü¶àüí™</div>
        <h1 style="color: var(--orange); margin: 10px 0; font-size: 2.5rem;">SHARK BOY '72</h1>
        <h2 style="color: var(--neon-blue); margin: 5px 0;">CHRONO-LINK</h2>
        <div class="dna-box">
            <p style="margin: 5px 0;">> YEAR: 2172</p>
            <p style="margin: 5px 0;">> AGENT: Shark-Human Hybrid #007</p>
            <p style="margin: 5px 0;">> MISSION: Travel to 1972 Munich Olympics</p>
            <p style="margin: 5px 0;">> OBJECTIVE: Defeat swimming legends using future genetics</p>
            <p style="margin: 5px 0; color: yellow;">> STATUS: Time machine activation required</p>
        </div>
        <button class="btn" style="background:lime; color:#000; margin-top:20px; font-size: 1.1rem;" onclick="activateTimeMachine()">‚ö° ACTIVATE TIME MACHINE ‚ö°</button>
    </div>

    <div id="calibration-screen" class="screen">
        <h2 style="color:var(--neon-blue);">TIME MACHINE CALIBRATION</h2>
        <div class="cal-status" id="cal-status">INITIALIZING CHRONO-SYNC...</div>
        <div style="border: 2px solid var(--neon-blue); padding: 20px; margin: 20px; background: rgba(0,0,0,0.5); font-family: monospace;">
            <div id="dive-test" style="display:none;">
                <p>TEST 1: TEMPORAL DIVE</p>
                <p style="font-size: 0.9rem;">When you see "GO!", tilt phone forward.</p>
                <div id="dive-signal" style="font-size: 2rem; color: yellow; margin: 20px 0;"></div>
            </div>
            <div id="flip-test" style="display:none;">
                <p>TEST 2: DIMENSIONAL FLIP</p>
                <p style="font-size: 0.9rem;">Rotate phone 360¬∞ in any direction.</p>
                <div id="flip-signal" style="font-size: 2rem; color: yellow; margin: 20px 0;">Rotate phone now!</div>
            </div>
            <div id="cal-complete" style="display:none;">
                <p style="color: lime; font-size: 1.5rem;">‚úì CHRONO-SYNC COMPLETE</p>
                <p style="font-size: 0.9rem;">Time stream locked on 1972.</p>
            </div>
        </div>
        <button class="btn" id="skip-cal-btn" onclick="skipCalibration()">SKIP CALIBRATION</button>
        <button class="btn" id="continue-btn" style="background:lime; color:#000; display:none;" onclick="showMenu()">[ INITIATE TIME TRAVEL ]</button>
    </div>

    <div id="menu" class="screen">
        <h1 style="margin:0;">MUNICH 1972</h1>
        <p style="margin-top:0; font-size:0.8rem;">SELECT TARGET EVENT</p>
        <button class="btn" onclick="startRace('fly100')">100m Butterfly (Spitz üá∫üá∏)</button>
        <button class="btn" onclick="startRace('fly200')">200m Butterfly (Spitz üá∫üá∏)</button>
        <button class="btn" onclick="startRace('free100')">100m Freestyle (Spitz üá∫üá∏)</button>
        <button class="btn" onclick="startRace('free200')">200m Freestyle (Spitz üá∫üá∏)</button>
        <button class="btn" onclick="startRace('back100')">100m Backstroke (Matthes üá©üá™)</button>
        <button class="btn" onclick="startRace('breast100')">100m Breaststroke (Taguchi üáØüáµ)</button>
        <button class="btn" onclick="startRace('im400')">400m IM (Larsson üá∏üá™)</button>
    </div>

    <div id="game-container" class="screen" style="padding:0;">
        <div id="hud">
            <div id="stopwatch">00:00.00</div><br>
            <div id="legend-name">VS --</div>
            <div id="signal" style="font-size: 3rem; color: yellow; margin-top:10px;"></div>
        </div>
        <div id="cramp-msg">CRAMP!</div>
        <canvas id="poolCanvas"></canvas>
        <div id="controls"></div>
    </div>

    <div id="result-screen" class="screen">
        <div id="win-lab">
            <h1 style="color:var(--neon-blue);">TIMELINE ALTERED!</h1>
            <div style="font-family:monospace; font-size: 1.2rem;">FUTURE DNA SUPERIOR: CONFIRMED</div>
            <div class="legend-portrait">ü•á</div>
            <div style="margin-top: 10px; font-size: 1.1rem;" id="win-time">--</div>
            <button class="btn" style="background:lime; color:#000; margin-top:20px;" onclick="startPhoto()">üì∏ CAPTURE VICTORY PHOTO</button>
        </div>
        <div id="loss-area">
            <h1 id="res-title">TIMELINE UNCHANGED</h1>
            <div class="legend-portrait">üèÜ</div>
            <p id="legend-final-name" style="font-size: 1.2rem;">--</p>
            <p style="font-size: 0.9rem; color: #aaa;">The legends remain undefeated</p>
        </div>
        <button class="btn" style="margin-top:20px;" onclick="location.reload()">üîÑ RETRY MISSION</button>
    </div>

    <div id="photo-screen" class="screen">
        <h2 style="margin: 10px 0; color: #000;">VICTORY PHOTO</h2>
        <p style="font-size: 0.9rem; margin: 5px 0; color: #000;">Position your mouth in the box</p>
        <div id="camera-container">
            <div class="video-container" style="position: relative; display: inline-block;">
                <video id="camera-video" autoplay playsinline style="max-width: 90vw; max-height: 60vh; border: 3px solid var(--neon-blue); border-radius: 10px;"></video>
                <!-- Face circle guide -->
                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <circle cx="50%" cy="40%" r="25%" fill="none" stroke="lime" stroke-width="3" stroke-dasharray="10,5"/>
                    <text x="50%" y="20%" text-anchor="middle" fill="lime" font-size="16" font-family="Arial">Position face here</text>
                </svg>
                <!-- Mouth placeholder box -->
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 15%; height: 8%; border: 3px solid red; background: rgba(255,0,0,0.2); border-radius: 10px;"></div>
                <div style="position: absolute; top: 59%; left: 50%; transform: translateX(-50%); color: red; font-size: 14px; font-weight: bold; text-shadow: 0 0 3px black;">MOUTH HERE</div>
            </div>
            <button class="btn" style="margin-top:15px; background: lime; color: #000; font-size: 1.2rem;" onclick="capturePhoto()">üì∏ TAKE PHOTO</button>
            <button class="btn" onclick="cancelPhoto()">CANCEL</button>
        </div>
        <div id="preview-container" class="hidden">
            <canvas id="photo-canvas"></canvas>
            <button class="btn" style="background:lime; color:#000; margin-top:10px; font-size: 1.1rem;" onclick="savePhoto()">üíæ SAVE TO PHOTOS</button>
            <button class="btn" onclick="retakePhoto()">üîÑ RETAKE</button>
            <button class="btn" onclick="cancelPhoto()">CANCEL</button>
        </div>
    </div>

<script>
    const events = {
        fly100: { t: 54.27, l: 2, n: "Mark Spitz", flag: "üá∫üá∏", stroke: "butterfly", eventName: "100m Butterfly" },
        fly200: { t: 120.70, l: 4, n: "Mark Spitz", flag: "üá∫üá∏", stroke: "butterfly", eventName: "200m Butterfly" },
        free100: { t: 51.22, l: 2, n: "Mark Spitz", flag: "üá∫üá∏", stroke: "freestyle", eventName: "100m Freestyle" },
        free200: { t: 112.78, l: 4, n: "Mark Spitz", flag: "üá∫üá∏", stroke: "freestyle", eventName: "200m Freestyle" },
        back100: { t: 56.58, l: 2, n: "Roland Matthes", flag: "üá©üá™", stroke: "backstroke", eventName: "100m Backstroke" },
        breast100: { t: 64.94, l: 2, n: "Nobutaka Taguchi", flag: "üáØüáµ", stroke: "breaststroke", eventName: "100m Breaststroke" },
        im400: { t: 271.98, l: 8, n: "Gunnar Larsson", flag: "üá∏üá™", stroke: "im", eventName: "400m IM" }
    };

    let pDist = 0, bDist = 0, isRacing = false, startTime = 0, finalTime = "";
    let oxy = 100, isCramped = false, lastArm = null, sameCount = 0, currentEvent;
    let audioContext = null, permissionsGranted = false, hasDived = false, lastFlipTime = 0;
    
    let calDiveComplete = false, calFlipComplete = false;
    let flyArmsReady = false; // Simplified butterfly - just detect ANY tilt
    
    let lastTilt = 0, backstrokeSpeed = 0, kicksAfterTurn = 0, justTurned = false;
    let sliderPosition = 0, sliderAtTop = false, sliderCycleComplete = false;
    let currentStroke = "butterfly", imSegment = 0;
    
    let cameraStream = null;

    function init() {
        document.getElementById('story-screen').style.display = 'flex';
    }

    async function activateTimeMachine() {
        // Initialize audio and motion sensors
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        // Request motion permissions
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try {
                const permission = await DeviceMotionEvent.requestPermission();
                permissionsGranted = (permission === 'granted');
                if (!permissionsGranted) {
                    alert('Motion sensors required for time travel! Please allow access.');
                    return;
                }
            } catch (error) {
                alert('Error activating motion sensors. Please try again.');
                return;
            }
        } else {
            permissionsGranted = true;
            // Activate sensors with dummy listener
            const activate = () => window.removeEventListener('devicemotion', activate);
            window.addEventListener('devicemotion', activate);
        }
        
        // Proceed to calibration
        document.getElementById('story-screen').style.display = 'none';
        document.getElementById('calibration-screen').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('dive-test').style.display = 'block';
            startDiveTest();
        }, 1000);
    }

    function startDiveTest() {
        const sig = document.getElementById('dive-signal');
        sig.innerText = "READY...";
        setTimeout(() => {
            sig.innerText = "GO!";
            sig.style.color = "lime";
            window.addEventListener('devicemotion', checkDiveCalibration);
        }, 1500);
    }

    function checkDiveCalibration(e) {
        if (calDiveComplete || !e.accelerationIncludingGravity) return;
        const y = e.accelerationIncludingGravity.y || 0;
        const z = e.accelerationIncludingGravity.z || 0;
        const x = e.accelerationIncludingGravity.x || 0;
        
        if (Math.abs(y) > 2 || Math.abs(z - 9.8) > 3 || Math.abs(x) > 2) {
            calDiveComplete = true;
            window.removeEventListener('devicemotion', checkDiveCalibration);
            document.getElementById('dive-signal').innerText = "‚úì TEMPORAL LOCK ACQUIRED";
            document.getElementById('dive-signal').style.color = "lime";
            
            if (audioContext) {
                const osc = audioContext.createOscillator();
                osc.connect(audioContext.destination);
                osc.frequency.value = 800;
                osc.start();
                osc.stop(audioContext.currentTime + 0.1);
            }
            
            setTimeout(() => {
                document.getElementById('dive-test').style.display = 'none';
                document.getElementById('flip-test').style.display = 'block';
                window.addEventListener('devicemotion', checkFlipCalibration);
            }, 1500);
        }
    }

    function checkFlipCalibration(e) {
        if (calFlipComplete || !e.rotationRate) return;
        const total = Math.abs(e.rotationRate.beta || 0) + Math.abs(e.rotationRate.gamma || 0) + Math.abs(e.rotationRate.alpha || 0);
        
        if (total > 200) {
            calFlipComplete = true;
            window.removeEventListener('devicemotion', checkFlipCalibration);
            document.getElementById('flip-signal').innerText = "‚úì DIMENSIONAL SYNC COMPLETE";
            document.getElementById('flip-signal').style.color = "lime";
            
            if (audioContext) {
                const osc = audioContext.createOscillator();
                osc.connect(audioContext.destination);
                osc.frequency.value = 1000;
                osc.start();
                osc.stop(audioContext.currentTime + 0.1);
            }
            
            setTimeout(completeCalibration, 1500);
        }
    }

    function completeCalibration() {
        document.getElementById('flip-test').style.display = 'none';
        document.getElementById('cal-complete').style.display = 'block';
        document.getElementById('cal-status').innerText = "TIME MACHINE READY";
        document.getElementById('cal-status').classList.add('cal-complete');
        document.getElementById('skip-cal-btn').style.display = 'none';
        document.getElementById('continue-btn').style.display = 'block';
    }

    function skipCalibration() {
        window.removeEventListener('devicemotion', checkDiveCalibration);
        window.removeEventListener('devicemotion', checkFlipCalibration);
        completeCalibration();
    }

    function showMenu() {
        document.getElementById('calibration-screen').style.display = 'none';
        document.getElementById('menu').style.display = 'flex';
    }

    function startRace(k) {
        currentEvent = events[k];
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('legend-name').innerText = `VS ${currentEvent.n} ${currentEvent.flag} (RECORD: ${currentEvent.t}s)`;
        
        pDist = 0; bDist = 0; oxy = 100; finalTime = "";
        isCramped = false; lastArm = null; sameCount = 0; hasDived = false; lastFlipTime = 0;
        flyArmsReady = false;
        backstrokeSpeed = 0; lastTilt = 0; kicksAfterTurn = 0; justTurned = false;
        sliderPosition = 0; sliderAtTop = false; sliderCycleComplete = false;
        
        if (currentEvent.stroke === "im") {
            currentStroke = "butterfly";
            imSegment = 0;
        } else {
            currentStroke = currentEvent.stroke;
        }
        
        setupControls(currentStroke);
        runSequence();
    }

    function setupControls(stroke) {
        const controls = document.getElementById('controls');
        controls.innerHTML = '';
        controls.className = `controls-${stroke}`;
        
        if (stroke === "freestyle") {
            controls.innerHTML = `
                <button class="swim-btn" id="l-btn">LEFT ARM</button>
                <button class="swim-btn" id="r-btn">RIGHT ARM</button>
                <button class="swim-btn breathe-btn" id="b-btn">BREATHE (O2: <span id="oxy">100</span>%)</button>
            `;
            document.getElementById('l-btn').addEventListener('click', () => swimFreestyle('L'));
            document.getElementById('r-btn').addEventListener('click', () => swimFreestyle('R'));
            document.getElementById('b-btn').addEventListener('click', () => { 
                if (isRacing && !isCramped) {
                    oxy = Math.min(100, oxy + 35);
                    document.getElementById('oxy').innerText = oxy.toFixed(0);
                }
            });
        } else if (stroke === "butterfly") {
            controls.innerHTML = `
                <div class="swim-btn tilt-zone" id="fly-tilt">
                    <div>üîÑ TILT PHONE üîÑ</div>
                    <div style="font-size: 0.8rem; margin-top: 5px;">Any direction = Arms</div>
                </div>
                <button class="swim-btn" id="fly-kick">KICK (Optional Boost)</button>
            `;
            document.getElementById('fly-kick').addEventListener('click', butterflyKick);
            window.addEventListener('devicemotion', handleButterflyTilt);
        } else if (stroke === "backstroke") {
            controls.innerHTML = `
                <div class="swim-btn rock-zone">üîÑ ROCK PHONE LEFT/RIGHT üîÑ</div>
                <button class="swim-btn" id="back-l-kick">LEFT KICK</button>
                <button class="swim-btn" id="back-r-kick">RIGHT KICK</button>
            `;
            document.getElementById('back-l-kick').addEventListener('click', () => backstrokeKick('L'));
            document.getElementById('back-r-kick').addEventListener('click', () => backstrokeKick('R'));
            window.addEventListener('devicemotion', handleBackstrokeRocking);
        } else if (stroke === "breaststroke") {
            controls.innerHTML = `
                <div class="slider-container">
                    <input type="range" min="0" max="100" value="0" class="arm-slider" id="arm-slider">
                    <div style="font-size:0.8rem; margin-top:10px;">ARMS<br>‚Üë Extend<br>‚Üì Pull</div>
                </div>
                <button class="swim-btn" id="breast-kick" style="font-size:1.5rem;">KICK</button>
            `;
            document.getElementById('arm-slider').addEventListener('input', handleBreaststrokeSlider);
            document.getElementById('breast-kick').addEventListener('click', breaststrokeKick);
        }
    }

    function swimFreestyle(arm) {
        if (!isRacing || isCramped) return;
        
        const btn = document.getElementById(arm === 'L' ? 'l-btn' : 'r-btn');
        const other = document.getElementById(arm === 'L' ? 'r-btn' : 'l-btn');
        
        if (oxy < 40) {
            const scale = 0.7 + (oxy / 100) * 0.3;
            btn.style.transform = `scale(${scale}) translate(${Math.random()*20-10}px, ${Math.random()*15-7}px)`;
            setTimeout(() => { btn.style.transform = 'scale(1)'; }, 150);
        }

        btn.classList.add('active-btn');
        other.classList.remove('active-btn');

        if (arm === lastArm) {
            sameCount++;
            if (sameCount >= 2) triggerCramp();
        } else { sameCount = 0; }
        
        lastArm = arm;
        let speed = 0.85;
        if (oxy < 20) speed = 0.3;
        else if (oxy < 50) speed = 0.6;
        
        pDist += speed;
        oxy -= 1.8;
        document.getElementById('oxy').innerText = Math.max(0, oxy.toFixed(0));
        checkRaceEnd();
    }

    function handleButterflyTilt(e) {
        if (!isRacing || currentStroke !== "butterfly" || !e.accelerationIncludingGravity) return;
        
        const y = e.accelerationIncludingGravity.y || 0;
        const z = e.accelerationIncludingGravity.z || 0;
        const x = e.accelerationIncludingGravity.x || 0;
        
        // Very forgiving - ANY tilt/movement counts as arms
        if (Math.abs(y) > 1.5 || Math.abs(z - 9.8) > 2 || Math.abs(x) > 1.5) {
            if (!flyArmsReady) {
                flyArmsReady = true;
                pDist += 0.8; // Base swimming from arms
                document.getElementById('fly-tilt').style.background = 'rgba(0,242,255,0.4)';
                
                // Reset after short delay
                setTimeout(() => {
                    flyArmsReady = false;
                    document.getElementById('fly-tilt').style.background = '';
                }, 800);
                
                checkRaceEnd();
            }
        }
    }

    function butterflyKick() {
        if (!isRacing || isCramped) return;
        
        // Optional boost
        pDist += 0.4;
        
        const btn = document.getElementById('fly-kick');
        btn.classList.add('active-btn');
        setTimeout(() => btn.classList.remove('active-btn'), 200);
        
        checkRaceEnd();
    }

    function handleBackstrokeRocking(e) {
        if (!isRacing || currentStroke !== "backstroke" || !e.accelerationIncludingGravity) return;
        
        const tilt = e.accelerationIncludingGravity.x || 0;
        const tiltChange = Math.abs(tilt - lastTilt);
        
        if (tiltChange > 1.5) {
            backstrokeSpeed = 0.4;
        } else {
            backstrokeSpeed *= 0.92;
        }
        
        lastTilt = tilt;
        pDist += backstrokeSpeed;
        checkRaceEnd();
    }

    function backstrokeKick(side) {
        if (!isRacing || isCramped) return;
        
        const lBtn = document.getElementById('back-l-kick');
        const rBtn = document.getElementById('back-r-kick');
        
        if (side === 'L') {
            lBtn.classList.add('active-btn');
            rBtn.classList.remove('active-btn');
        } else {
            rBtn.classList.add('active-btn');
            lBtn.classList.remove('active-btn');
        }
        
        if (justTurned && kicksAfterTurn < 5) {
            if (lBtn.classList.contains('active-btn') && rBtn.classList.contains('active-btn')) {
                pDist += 1.5;
                kicksAfterTurn++;
                
                const sig = document.getElementById('signal');
                sig.innerText = "BUTTERFLY KICK!";
                sig.style.color = "cyan";
                setTimeout(() => { sig.innerText = ""; }, 400);
            } else {
                pDist += 0.5;
            }
        } else {
            pDist += 0.5;
        }
        
        checkRaceEnd();
    }

    function handleBreaststrokeSlider(e) {
        if (!isRacing) return;
        
        const val = parseInt(e.target.value);
        
        if (val >= 95 && !sliderAtTop) {
            sliderAtTop = true;
        }
        
        if (val <= 5 && sliderAtTop && !sliderCycleComplete) {
            sliderCycleComplete = true;
            document.getElementById('breast-kick').style.background = 'lime';
            document.getElementById('breast-kick').style.color = '#000';
        }
        
        sliderPosition = val;
    }

    function breaststrokeKick() {
        if (!isRacing || isCramped || !sliderCycleComplete) return;
        
        pDist += 1.8;
        
        sliderCycleComplete = false;
        sliderAtTop = false;
        document.getElementById('arm-slider').value = 0;
        document.getElementById('breast-kick').style.background = '';
        document.getElementById('breast-kick').style.color = '';
        
        checkRaceEnd();
    }

    function runSequence() {
        const sig = document.getElementById('signal');
        sig.innerText = "READY...";
        setTimeout(() => {
            sig.innerText = "SET...";
            window.addEventListener('devicemotion', handleFalseStart);
            setTimeout(() => {
                if (audioContext) {
                    const osc = audioContext.createOscillator();
                    osc.connect(audioContext.destination);
                    osc.frequency.value = 800;
                    osc.start();
                    osc.stop(audioContext.currentTime + 0.15);
                }
                
                sig.innerText = "GO! DIVE IN!";
                sig.style.color = "lime";
                window.removeEventListener('devicemotion', handleFalseStart);
                window.addEventListener('devicemotion', handleDiveIn);
                
            }, Math.random() * 3000 + 1000);
        }, 1500);
    }

    function handleFalseStart(e) {
        if (e.accelerationIncludingGravity && Math.abs(e.accelerationIncludingGravity.z) > 15) {
            window.removeEventListener('devicemotion', handleFalseStart);
            alert("FALSE START! DQ!"); 
            location.reload();
        }
    }

    function handleDiveIn(e) {
        if (hasDived || !e.accelerationIncludingGravity) return;
        
        const y = e.accelerationIncludingGravity.y || 0;
        const z = e.accelerationIncludingGravity.z || 0;
        const x = e.accelerationIncludingGravity.x || 0;
        
        if (Math.abs(y) > 2 || Math.abs(z - 9.8) > 3 || Math.abs(x) > 2) {
            hasDived = true;
            isRacing = true;
            startTime = performance.now();
            
            const sig = document.getElementById('signal');
            sig.innerText = "DIVE!";
            sig.style.color = "cyan";
            setTimeout(() => { sig.innerText = ""; sig.style.color = "yellow"; }, 800);
            
            window.removeEventListener('devicemotion', handleDiveIn);
            window.addEventListener('devicemotion', handleFlip);
            requestAnimationFrame(gameLoop);
        }
    }

    function handleFlip(e) {
        if (!isRacing || !e.rotationRate) return;
        
        const now = Date.now();
        if (now - lastFlipTime < 1000) return;
        
        const total = Math.abs(e.rotationRate.beta || 0) + Math.abs(e.rotationRate.gamma || 0) + Math.abs(e.rotationRate.alpha || 0);
        const nearWall = pDist % 100 > 88 && pDist % 100 < 99;
        
        if (total > 200 && nearWall) {
            lastFlipTime = now;
            pDist += 5;
            
            if (currentStroke === "backstroke") {
                justTurned = true;
                kicksAfterTurn = 0;
            }
            
            if (audioContext) {
                const osc = audioContext.createOscillator();
                osc.connect(audioContext.destination);
                osc.frequency.value = 600;
                osc.start();
                osc.stop(audioContext.currentTime + 0.1);
            }
            
            const sig = document.getElementById('signal');
            sig.innerText = "FLIP TURN! +5m";
            sig.style.color = "lime";
            setTimeout(() => { sig.innerText = ""; sig.style.color = "yellow"; }, 500);
        }
    }

    function triggerCramp() {
        isCramped = true; 
        sameCount = 0;
        document.getElementById('cramp-msg').style.display = 'block';
        
        if (audioContext) {
            const osc = audioContext.createOscillator();
            osc.connect(audioContext.destination);
            osc.frequency.value = 200;
            osc.start();
            osc.stop(audioContext.currentTime + 0.3);
        }
        
        setTimeout(() => { 
            isCramped = false; 
            document.getElementById('cramp-msg').style.display = 'none'; 
        }, 2500);
    }

    function checkRaceEnd() {
        if (currentEvent.stroke === "im") {
            const segmentLength = 200;
            const segmentComplete = pDist >= (imSegment + 1) * segmentLength;
            
            if (segmentComplete && imSegment < 3) {
                imSegment++;
                const strokes = ["butterfly", "backstroke", "breaststroke", "freestyle"];
                currentStroke = strokes[imSegment];
                
                window.removeEventListener('devicemotion', handleBackstrokeRocking);
                window.removeEventListener('devicemotion', handleButterflyTilt);
                
                setupControls(currentStroke);
                
                const sig = document.getElementById('signal');
                sig.innerText = `${currentStroke.toUpperCase()}!`;
                sig.style.color = "yellow";
                setTimeout(() => { sig.innerText = ""; }, 1500);
            }
        }
        
        if (pDist >= currentEvent.l * 100) endRace(true);
    }

    function gameLoop(t) {
        if (!isRacing) return;
        let elapsed = (t - startTime) / 1000;
        let m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        let s = (elapsed % 60).toFixed(2).padStart(5, '0');
        document.getElementById('stopwatch').innerText = `${m}:${s}`;

        let botBase = (100 * currentEvent.l) / currentEvent.t;
        let speedMult = (pDist > bDist + 6) ? 1.12 : 1.0;
        bDist += (botBase / 60) * speedMult;

        if (bDist >= currentEvent.l * 100) endRace(false);
        
        draw();
        requestAnimationFrame(gameLoop);
    }

    function draw() {
        const c = document.getElementById('poolCanvas'); 
        const ctx = c.getContext('2d');
        c.width = window.innerWidth; 
        c.height = window.innerHeight * 0.65;
        ctx.fillStyle = "#0055aa"; 
        ctx.fillRect(0, 0, c.width, c.height);
        
        ctx.strokeStyle = "white"; 
        ctx.setLineDash([10, 20]);
        ctx.beginPath(); 
        ctx.moveTo(c.width / 2, 0); 
        ctx.lineTo(c.width / 2, c.height); 
        ctx.stroke();

        const getY = (d) => {
            let p = d % 100; 
            let l = Math.floor(d / 100);
            let y = (p / 100) * (c.height - 100) + 50;
            return (l % 2 === 0) ? y : c.height - y;
        };

        ctx.save(); 
        ctx.translate(c.width * 0.25, getY(bDist));
        if (Math.floor(bDist / 100) % 2 !== 0) ctx.rotate(Math.PI);
        ctx.font = "40px Arial"; 
        ctx.fillText("üèä", -20, 20); 
        ctx.restore();

        ctx.save(); 
        ctx.translate(c.width * 0.75, getY(pDist));
        if (Math.floor(pDist / 100) % 2 !== 0) ctx.rotate(Math.PI);
        ctx.font = "50px Arial"; 
        ctx.fillText("ü¶à", -25, 25); 
        ctx.restore();
    }

    function endRace(win) {
        isRacing = false;
        window.removeEventListener('devicemotion', handleFlip);
        window.removeEventListener('devicemotion', handleBackstrokeRocking);
        window.removeEventListener('devicemotion', handleButterflyTilt);
        
        const elapsed = (performance.now() - startTime) / 1000;
        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toFixed(2).padStart(5, '0');
        finalTime = `${m}:${s}`;
        
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';
        
        if (win) {
            document.getElementById('win-lab').style.display = 'flex';
            document.getElementById('loss-area').style.display = 'none';
            document.getElementById('win-time').innerText = `Time: ${finalTime}`;
        } else {
            document.getElementById('win-lab').style.display = 'none';
            document.getElementById('loss-area').style.display = 'block';
            document.getElementById('legend-final-name').innerText = `${currentEvent.n} ${currentEvent.flag}`;
        }
    }

    // PHOTO FEATURE
    async function startPhoto() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('photo-screen').style.display = 'flex';
        
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            document.getElementById('camera-video').srcObject = cameraStream;
        } catch (error) {
            alert('Camera access required. Please enable camera permissions.');
            cancelPhoto();
        }
    }

    function capturePhoto() {
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('photo-canvas');
        const ctx = canvas.getContext('2d');
        
        // Flash effect
        const flash = document.createElement('div');
        flash.style.position = 'fixed';
        flash.style.top = '0';
        flash.style.left = '0';
        flash.style.width = '100vw';
        flash.style.height = '100vh';
        flash.style.background = 'white';
        flash.style.zIndex = '9999';
        flash.style.opacity = '1';
        flash.style.transition = 'opacity 0.3s';
        document.body.appendChild(flash);
        
        // Camera shutter sound
        if (audioContext) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = 800;
            gain.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            osc.start();
            osc.stop(audioContext.currentTime + 0.1);
        }
        
        setTimeout(() => {
            flash.style.opacity = '0';
            setTimeout(() => document.body.removeChild(flash), 300);
        }, 100);
        
        // Create Wheaties box (portrait orientation)
        canvas.width = 600;
        canvas.height = 900;
        
        // Orange background
        ctx.fillStyle = '#ff8c00';
        ctx.fillRect(0, 0, 600, 900);
        
        // Wheaties logo at top
        ctx.fillStyle = '#ff6347';
        ctx.strokeStyle = '#8B0000';
        ctx.lineWidth = 4;
        ctx.font = 'bold 90px Arial';
        ctx.strokeText('Wheaties', 80, 100);
        ctx.fillText('Wheaties', 80, 100);
        
        // Registered trademark
        ctx.font = '20px Arial';
        ctx.fillStyle = '#000';
        ctx.fillText('¬Æ', 520, 70);
        
        // Event name
        ctx.fillStyle = '#00f2ff';
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.font = 'bold 32px Arial';
        const eventText = currentEvent.eventName.toUpperCase();
        ctx.strokeText(eventText, 300 - ctx.measureText(eventText).width/2, 160);
        ctx.fillText(eventText, 300 - ctx.measureText(eventText).width/2, 160);
        
        // Time
        ctx.fillStyle = '#000';
        ctx.font = 'bold 28px Arial';
        const timeText = `TIME: ${finalTime}`;
        ctx.fillText(timeText, 300 - ctx.measureText(timeText).width/2, 200);
        
        // Photo area with border
        ctx.fillStyle = '#fff';
        ctx.fillRect(50, 230, 500, 500);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 5;
        ctx.strokeRect(50, 230, 500, 500);
        
        // Draw captured photo
        const aspectRatio = video.videoWidth / video.videoHeight;
        let drawWidth = 500;
        let drawHeight = 500;
        
        if (aspectRatio > 1) {
            drawHeight = drawWidth / aspectRatio;
        } else {
            drawWidth = drawHeight * aspectRatio;
        }
        
        const offsetX = 50 + (500 - drawWidth) / 2;
        const offsetY = 230 + (500 - drawHeight) / 2;
        
        ctx.drawImage(video, offsetX, offsetY, drawWidth, drawHeight);
        
        // Draw scribbled mustache (above mouth position which is at 50% of photo)
        const mustacheY = offsetY + drawHeight * 0.45; // 45% down (above the mouth at 50%)
        const mustacheX = offsetX + drawWidth * 0.5;
        const mustacheWidth = drawWidth * 0.25;
        
        ctx.strokeStyle = '#3d2817'; // Dark brown
        ctx.lineWidth = 6;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // Draw multiple scribbled strokes for natural look
        for (let i = 0; i < 5; i++) {
            ctx.beginPath();
            // Left side of mustache
            ctx.moveTo(mustacheX - mustacheWidth/2, mustacheY + Math.random() * 3);
            ctx.quadraticCurveTo(
                mustacheX - mustacheWidth/4, mustacheY - 8 + Math.random() * 4,
                mustacheX - 5, mustacheY - 5 + Math.random() * 3
            );
            // Right side of mustache
            ctx.moveTo(mustacheX + 5, mustacheY - 5 + Math.random() * 3);
            ctx.quadraticCurveTo(
                mustacheX + mustacheWidth/4, mustacheY - 8 + Math.random() * 4,
                mustacheX + mustacheWidth/2, mustacheY + Math.random() * 3
            );
            ctx.stroke();
        }
        
        // Thicker center strokes
        ctx.lineWidth = 8;
        for (let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.moveTo(mustacheX - mustacheWidth/3, mustacheY + Math.random() * 2);
            ctx.lineTo(mustacheX + mustacheWidth/3, mustacheY + Math.random() * 2);
            ctx.stroke();
        }
        
        // Draw gold medal on chest (70% down photo)
        const medalY = offsetY + drawHeight * 0.7;
        const medalX = mustacheX;
        ctx.font = '80px Arial';
        ctx.fillText('ü•á', medalX - 40, medalY);
        
        // Bottom text
        ctx.fillStyle = '#000';
        ctx.font = 'bold 24px Arial';
        ctx.fillText('1972 OLYMPICS CHAMPION', 300 - ctx.measureText('1972 OLYMPICS CHAMPION').width/2, 780);
        
        ctx.font = '20px Arial';
        ctx.fillText('Breakfast of Champions', 300 - ctx.measureText('Breakfast of Champions').width/2, 820);
        
        // Small cereal box tagline
        ctx.font = 'italic 16px Arial';
        ctx.fillStyle = '#666';
        ctx.fillText('The Breakfast of Champions since 1924', 300 - ctx.measureText('The Breakfast of Champions since 1924').width/2, 860);
        
        // Stop camera
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        
        document.getElementById('camera-container').classList.add('hidden');
        document.getElementById('preview-container').classList.remove('hidden');
    }

    function savePhoto() {
        const canvas = document.getElementById('photo-canvas');
        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wheaties-${currentEvent.eventName.replace(/\s/g, '-')}-${finalTime.replace(/:/g, '-')}.png`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Wheaties box saved to downloads!');
            location.reload();
        });
    }

    function retakePhoto() {
        document.getElementById('preview-container').classList.add('hidden');
        document.getElementById('camera-container').classList.remove('hidden');
        startPhoto();
    }

    function cancelPhoto() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        location.reload();
    }
</script>
</body>
</html>
