<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shark Boy '72: Chrono-Link</title>
    <style>
        :root { --orange: #ff8c00; --neon-blue: #00f2ff; --pool-blue: #0077be; }
        body { margin: 0; background: #000; color: white; font-family: 'Arial Black', sans-serif; overflow: hidden; touch-action: none; }
        
        .screen { width: 100vw; height: 100vh; display: none; position: absolute; top: 0; left: 0; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; box-sizing: border-box; }
        
        #story-screen { background: radial-gradient(circle, #001a33 0%, #000 100%); font-family: monospace; color: var(--neon-blue); }
        .dna-box { border: 1px solid var(--neon-blue); padding: 20px; text-align: left; background: rgba(0,0,0,0.5); }

        #calibration-screen { background: radial-gradient(circle, #1a0033 0%, #000 100%); font-family: monospace; color: var(--neon-blue); }
        .cal-status { font-size: 1.5rem; margin: 20px 0; color: yellow; }
        .cal-complete { color: lime !important; }

        #menu { background: var(--orange); }
        .btn { padding: 10px; margin: 4px; border: none; border-radius: 8px; background: white; color: var(--orange); font-size: 0.9rem; font-weight: bold; width: 90%; max-width: 400px; box-shadow: 0 4px #cc7000; cursor: pointer; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px #cc7000; }
        
        #hud { position: absolute; top: 10px; width: 100%; z-index: 10; pointer-events: none; }
        #stopwatch { background: #111; border: 3px solid #444; border-radius: 8px; padding: 8px; color: #f00; font-size: 2.2rem; font-family: monospace; }
        #legend-name { background: rgba(0,0,0,0.7); font-size: 0.9rem; padding: 3px 10px; border-radius: 10px; margin-top: 5px; display: inline-block; }
        
        #controls { position: absolute; bottom: 0; width: 100%; height: 35%; display: grid; gap: 10px; padding: 15px; box-sizing: border-box; background: rgba(0,0,0,0.8); }
        
        .controls-freestyle { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .swim-btn { background: rgba(255,255,255,0.1); border: 2px solid white; border-radius: 12px; color: white; transition: background 0.1s, box-shadow 0.1s; position: relative; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .active-btn { background: var(--neon-blue) !important; color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        .breathe-btn { grid-column: span 2; }
        
        .controls-butterfly { grid-template-columns: 1fr 1fr; grid-template-rows: 2fr 1fr; }
        .rock-zone { grid-column: span 2; background: rgba(255,140,0,0.2); border: 3px dashed white; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        
        .controls-backstroke { grid-template-columns: 1fr 1fr; grid-template-rows: 2fr 1fr; }
        
        .controls-breaststroke { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr; }
        .slider-container { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .arm-slider { -webkit-appearance: none; width: 80%; height: 200px; background: linear-gradient(to top, #00f2ff, #ff8c00); writing-mode: bt-lr; -webkit-writing-mode: bt-lr; transform: rotate(270deg); cursor: pointer; border-radius: 10px; }
        .arm-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 50px; height: 50px; background: white; border-radius: 50%; cursor: pointer; border: 3px solid #000; }
        .arm-slider::-moz-range-thumb { width: 50px; height: 50px; background: white; border-radius: 50%; cursor: pointer; border: 3px solid #000; }
        
        #cramp-msg { position: absolute; top: 45%; width: 100%; color: red; font-size: 3.5rem; display: none; z-index: 100; text-shadow: 2px 2px #000; }
        #win-lab { display: none; width: 100%; height: 100%; background: #001a33; border: 2px solid var(--neon-blue); align-items: center; justify-content: center; flex-direction: column; }
        
        .legend-portrait { width: 200px; height: 200px; border-radius: 10px; border: 3px solid var(--orange); background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%); display: flex; align-items: center; justify-content: center; font-size: 80px; margin: 20px auto; box-shadow: 0 8px 16px rgba(0,0,0,0.3); }
        
        /* Wheaties Box Photo Screen */
        #wheaties-screen { background: var(--orange); }
        #photo-canvas { max-width: 90%; max-height: 60vh; border: 3px solid #000; margin: 20px 0; }
        #camera-video { max-width: 90%; max-height: 50vh; border: 3px solid var(--neon-blue); }
        .hidden { display: none !important; }
    </style>
</head>
<body onload="init()">

    <div id="story-screen" class="screen">
        <div class="dna-box">
            <h2 style="margin:0;">MISSION: CHRONO-72</h2>
            <p>> YEAR: 2172</p>
            <p>> DNA: Shark-Human Hybrid #007</p>
            <p>> OBJECTIVE: Prove genetic evolution by defeating the natural legends of 1972.</p>
            <p>> MISSION: Complete calibration to unlock time-stream.</p>
        </div>
        <button class="btn" style="background:var(--neon-blue); color:#000; margin-top:20px;" onclick="showCalibration()">[ BEGIN CALIBRATION ]</button>
    </div>

    <div id="calibration-screen" class="screen">
        <h2 style="color:var(--neon-blue);">CALIBRATION PROTOCOL</h2>
        <div class="cal-status" id="cal-status">TESTING DIVE MECHANISM...</div>
        <div style="border: 2px solid var(--neon-blue); padding: 20px; margin: 20px; background: rgba(0,0,0,0.5); font-family: monospace;">
            <div id="dive-test" style="display:none;">
                <p>TEST 1: DIVE ENTRY</p>
                <p style="font-size: 0.9rem;">When you see "GO!", tilt phone forward to dive.</p>
                <div id="dive-signal" style="font-size: 2rem; color: yellow; margin: 20px 0;"></div>
            </div>
            <div id="flip-test" style="display:none;">
                <p>TEST 2: WALL TURN</p>
                <p style="font-size: 0.9rem;">Rotate phone 360¬∞ in any direction.</p>
                <div id="flip-signal" style="font-size: 2rem; color: yellow; margin: 20px 0;">Rotate phone now!</div>
            </div>
            <div id="cal-complete" style="display:none;">
                <p style="color: lime; font-size: 1.5rem;">‚úì CALIBRATION COMPLETE</p>
                <p style="font-size: 0.9rem;">All systems operational.</p>
            </div>
        </div>
        <button class="btn" id="skip-cal-btn" onclick="skipCalibration()">SKIP CALIBRATION</button>
        <button class="btn" id="continue-btn" style="background:lime; color:#000; display:none;" onclick="showMenu()">[ INITIATE FINAL TIME TRAVEL ]</button>
    </div>

    <div id="menu" class="screen">
        <h1 style="margin:0;">SHARK BOY '72</h1>
        <p style="margin-top:0; font-size:0.8rem;">SELECT OLYMPIC EVENT</p>
        <button class="btn" onclick="startRace('fly100')">100m Butterfly (Spitz üá∫üá∏)</button>
        <button class="btn" onclick="startRace('fly200')">200m Butterfly (Spitz üá∫üá∏)</button>
        <button class="btn" onclick="startRace('free100')">100m Freestyle (Spitz üá∫üá∏)</button>
        <button class="btn" onclick="startRace('free200')">200m Freestyle (Spitz üá∫üá∏)</button>
        <button class="btn" onclick="startRace('back100')">100m Backstroke (Matthes üá©üá™)</button>
        <button class="btn" onclick="startRace('breast100')">100m Breaststroke (Taguchi üáØüáµ)</button>
        <button class="btn" onclick="startRace('im400')">400m IM (Larsson üá∏üá™)</button>
    </div>

    <div id="game-container" class="screen" style="padding:0;">
        <div id="hud">
            <div id="stopwatch">00:00.00</div><br>
            <div id="legend-name">VS --</div>
            <div id="signal" style="font-size: 3rem; color: yellow; margin-top:10px;"></div>
        </div>
        <div id="cramp-msg">CRAMP!</div>
        <canvas id="poolCanvas"></canvas>
        <div id="controls"></div>
    </div>

    <div id="result-screen" class="screen">
        <div id="win-lab">
            <h1 style="color:var(--neon-blue);">GENETIC SUPERIORITY</h1>
            <div style="font-family:monospace;">FUTURE DNA VERIFIED: 100%</div>
            <div class="legend-portrait">ü•à</div>
            <button class="btn" style="background:lime; color:#000; margin-top:20px;" onclick="startWheaties()">üì∏ CLAIM YOUR WHEATIES BOX!</button>
        </div>
        <div id="loss-area">
            <h1 id="res-title">LEGEND REMAINS CHAMPION</h1>
            <div class="legend-portrait">üèÜ</div>
            <p id="legend-final-name" style="font-size: 1.2rem;">--</p>
        </div>
        <button class="btn" style="margin-top:20px;" onclick="location.reload()">RE-SYNC DNA</button>
    </div>

    <div id="wheaties-screen" class="screen">
        <h1 style="margin:0;">CREATE YOUR WHEATIES BOX</h1>
        <div id="camera-container">
            <video id="camera-video" autoplay playsinline></video>
            <button class="btn" style="margin-top:10px;" onclick="capturePhoto()">üì∏ CAPTURE PHOTO</button>
            <button class="btn" onclick="cancelWheaties()">CANCEL</button>
        </div>
        <div id="preview-container" class="hidden">
            <canvas id="photo-canvas"></canvas>
            <button class="btn" style="background:lime; color:#000; margin-top:10px;" onclick="saveWheaties()">üíæ SAVE TO PHOTOS</button>
            <button class="btn" onclick="retakePhoto()">üîÑ RETAKE</button>
            <button class="btn" onclick="cancelWheaties()">CANCEL</button>
        </div>
    </div>

<script>
    const events = {
        fly100: { t: 54.27, l: 2, n: "Mark Spitz", flag: "üá∫üá∏", stroke: "butterfly", eventName: "100m Butterfly" },
        fly200: { t: 120.70, l: 4, n: "Mark Spitz", flag: "üá∫üá∏", stroke: "butterfly", eventName: "200m Butterfly" },
        free100: { t: 51.22, l: 2, n: "Mark Spitz", flag: "üá∫üá∏", stroke: "freestyle", eventName: "100m Freestyle" },
        free200: { t: 112.78, l: 4, n: "Mark Spitz", flag: "üá∫üá∏", stroke: "freestyle", eventName: "200m Freestyle" },
        back100: { t: 56.58, l: 2, n: "Roland Matthes", flag: "üá©üá™", stroke: "backstroke", eventName: "100m Backstroke" },
        breast100: { t: 64.94, l: 2, n: "Nobutaka Taguchi", flag: "üáØüáµ", stroke: "breaststroke", eventName: "100m Breaststroke" },
        im400: { t: 271.98, l: 8, n: "Gunnar Larsson", flag: "üá∏üá™", stroke: "im", eventName: "400m IM" }
    };

    let pDist = 0, bDist = 0, isRacing = false, startTime = 0, finalTime = "";
    let oxy = 100, isCramped = false, lastArm = null, sameCount = 0, currentEvent;
    let audioContext = null, permissionsGranted = false, hasDived = false, lastFlipTime = 0;
    
    let calDiveComplete = false, calFlipComplete = false;
    let flyLeftArm = false, flyRightArm = false, flyLeftKick = false, flyRightKick = false;
    let flyRockPhase = "neutral"; // neutral, down, up
    let lastFlyPitch = 0;
    
    let lastTilt = 0, backstrokeSpeed = 0, kicksAfterTurn = 0, justTurned = false;
    let sliderPosition = 0, sliderAtTop = false, sliderCycleComplete = false;
    let currentStroke = "butterfly", imSegment = 0;
    
    let cameraStream = null, capturedImage = null;

    async function init() {
        document.getElementById('story-screen').style.display = 'flex';
        
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try {
                const permission = await DeviceMotionEvent.requestPermission();
                permissionsGranted = (permission === 'granted');
            } catch (error) {
                permissionsGranted = false;
            }
        } else {
            permissionsGranted = true;
        }
    }

    function showCalibration() {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        document.getElementById('story-screen').style.display = 'none';
        document.getElementById('calibration-screen').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('dive-test').style.display = 'block';
            startDiveTest();
        }, 1000);
    }

    function startDiveTest() {
        const sig = document.getElementById('dive-signal');
        sig.innerText = "READY...";
        setTimeout(() => {
            sig.innerText = "GO!";
            sig.style.color = "lime";
            window.addEventListener('devicemotion', checkDiveCalibration);
        }, 1500);
    }

    function checkDiveCalibration(e) {
        if (calDiveComplete || !e.accelerationIncludingGravity) return;
        const y = e.accelerationIncludingGravity.y || 0;
        const z = e.accelerationIncludingGravity.z || 0;
        const x = e.accelerationIncludingGravity.x || 0;
        
        if (Math.abs(y) > 3 || Math.abs(z - 9.8) > 4 || Math.abs(x) > 3) {
            calDiveComplete = true;
            window.removeEventListener('devicemotion', checkDiveCalibration);
            document.getElementById('dive-signal').innerText = "‚úì DIVE DETECTED";
            document.getElementById('dive-signal').style.color = "lime";
            
            if (audioContext) {
                const osc = audioContext.createOscillator();
                osc.connect(audioContext.destination);
                osc.frequency.value = 800;
                osc.start();
                osc.stop(audioContext.currentTime + 0.1);
            }
            
            setTimeout(() => {
                document.getElementById('dive-test').style.display = 'none';
                document.getElementById('flip-test').style.display = 'block';
                window.addEventListener('devicemotion', checkFlipCalibration);
            }, 1500);
        }
    }

    function checkFlipCalibration(e) {
        if (calFlipComplete || !e.rotationRate) return;
        const total = Math.abs(e.rotationRate.beta || 0) + Math.abs(e.rotationRate.gamma || 0) + Math.abs(e.rotationRate.alpha || 0);
        
        if (total > 200) {
            calFlipComplete = true;
            window.removeEventListener('devicemotion', checkFlipCalibration);
            document.getElementById('flip-signal').innerText = "‚úì FLIP DETECTED";
            document.getElementById('flip-signal').style.color = "lime";
            
            if (audioContext) {
                const osc = audioContext.createOscillator();
                osc.connect(audioContext.destination);
                osc.frequency.value = 1000;
                osc.start();
                osc.stop(audioContext.currentTime + 0.1);
            }
            
            setTimeout(completeCalibration, 1500);
        }
    }

    function completeCalibration() {
        document.getElementById('flip-test').style.display = 'none';
        document.getElementById('cal-complete').style.display = 'block';
        document.getElementById('cal-status').innerText = "CALIBRATION COMPLETE";
        document.getElementById('cal-status').classList.add('cal-complete');
        document.getElementById('skip-cal-btn').style.display = 'none';
        document.getElementById('continue-btn').style.display = 'block';
    }

    function skipCalibration() {
        window.removeEventListener('devicemotion', checkDiveCalibration);
        window.removeEventListener('devicemotion', checkFlipCalibration);
        completeCalibration();
    }

    function showMenu() {
        document.getElementById('calibration-screen').style.display = 'none';
        document.getElementById('menu').style.display = 'flex';
    }

    function startRace(k) {
        currentEvent = events[k];
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('legend-name').innerText = `VS ${currentEvent.n} ${currentEvent.flag} (RECORD: ${currentEvent.t}s)`;
        
        pDist = 0; bDist = 0; oxy = 100; finalTime = "";
        isCramped = false; lastArm = null; sameCount = 0; hasDived = false; lastFlipTime = 0;
        flyLeftArm = false; flyRightArm = false; flyLeftKick = false; flyRightKick = false;
        flyRockPhase = "neutral"; lastFlyPitch = 0;
        backstrokeSpeed = 0; lastTilt = 0; kicksAfterTurn = 0; justTurned = false;
        sliderPosition = 0; sliderAtTop = false; sliderCycleComplete = false;
        
        if (currentEvent.stroke === "im") {
            currentStroke = "butterfly";
            imSegment = 0;
        } else {
            currentStroke = currentEvent.stroke;
        }
        
        setupControls(currentStroke);
        runSequence();
    }

    function setupControls(stroke) {
        const controls = document.getElementById('controls');
        controls.innerHTML = '';
        controls.className = `controls-${stroke}`;
        
        if (stroke === "freestyle") {
            controls.innerHTML = `
                <button class="swim-btn" id="l-btn">LEFT ARM</button>
                <button class="swim-btn" id="r-btn">RIGHT ARM</button>
                <button class="swim-btn breathe-btn" id="b-btn">BREATHE (O2: <span id="oxy">100</span>%)</button>
            `;
            document.getElementById('l-btn').addEventListener('click', () => swimFreestyle('L'));
            document.getElementById('r-btn').addEventListener('click', () => swimFreestyle('R'));
            document.getElementById('b-btn').addEventListener('click', () => { 
                if (isRacing && !isCramped) {
                    oxy = Math.min(100, oxy + 35);
                    document.getElementById('oxy').innerText = oxy.toFixed(0);
                }
            });
        } else if (stroke === "butterfly") {
            controls.innerHTML = `
                <div class="swim-btn rock-zone" id="fly-rock">üîÑ ROCK PHONE UP/DOWN<br>‚Üì Arms Extend ‚Üë Arms Pull üîÑ</div>
                <button class="swim-btn" id="fly-l-kick">LEFT KICK</button>
                <button class="swim-btn" id="fly-r-kick">RIGHT KICK</button>
            `;
            document.getElementById('fly-l-kick').addEventListener('click', () => butterflyKick('L'));
            document.getElementById('fly-r-kick').addEventListener('click', () => butterflyKick('R'));
            window.addEventListener('devicemotion', handleButterflyRocking);
        } else if (stroke === "backstroke") {
            controls.innerHTML = `
                <div class="swim-btn rock-zone" id="rock-zone">üîÑ ROCK PHONE LEFT/RIGHT üîÑ</div>
                <button class="swim-btn" id="back-l-kick">LEFT KICK</button>
                <button class="swim-btn" id="back-r-kick">RIGHT KICK</button>
            `;
            document.getElementById('back-l-kick').addEventListener('click', () => backstrokeKick('L'));
            document.getElementById('back-r-kick').addEventListener('click', () => backstrokeKick('R'));
            window.addEventListener('devicemotion', handleBackstrokeRocking);
        } else if (stroke === "breaststroke") {
            controls.innerHTML = `
                <div class="slider-container">
                    <input type="range" min="0" max="100" value="0" class="arm-slider" id="arm-slider">
                    <div style="font-size:0.8rem; margin-top:10px;">ARMS<br>‚Üë Extend<br>‚Üì Pull</div>
                </div>
                <button class="swim-btn" id="breast-kick" style="font-size:1.5rem;">KICK</button>
            `;
            document.getElementById('arm-slider').addEventListener('input', handleBreaststrokeSlider);
            document.getElementById('breast-kick').addEventListener('click', breaststrokeKick);
        }
    }

    function swimFreestyle(arm) {
        if (!isRacing || isCramped) return;
        
        const btn = document.getElementById(arm === 'L' ? 'l-btn' : 'r-btn');
        const other = document.getElementById(arm === 'L' ? 'r-btn' : 'l-btn');
        
        if (oxy < 40) {
            const scale = 0.7 + (oxy / 100) * 0.3;
            btn.style.transform = `scale(${scale}) translate(${Math.random()*20-10}px, ${Math.random()*15-7}px)`;
            setTimeout(() => { btn.style.transform = 'scale(1)'; }, 150);
        }

        btn.classList.add('active-btn');
        other.classList.remove('active-btn');

        if (arm === lastArm) {
            sameCount++;
            if (sameCount >= 2) triggerCramp();
        } else { sameCount = 0; }
        
        lastArm = arm;
        let speed = 0.85;
        if (oxy < 20) speed = 0.3;
        else if (oxy < 50) speed = 0.6;
        
        pDist += speed;
        oxy -= 1.8;
        document.getElementById('oxy').innerText = Math.max(0, oxy.toFixed(0));
        checkRaceEnd();
    }

    function handleButterflyRocking(e) {
        if (!isRacing || currentStroke !== "butterfly" || !e.accelerationIncludingGravity) return;
        
        const pitch = e.accelerationIncludingGravity.y || 0;
        const pitchDiff = pitch - lastFlyPitch;
        
        // Detect down tilt (arms extend)
        if (pitchDiff < -2 && flyRockPhase !== "down") {
            flyRockPhase = "down";
            flyLeftArm = true;
            document.getElementById('fly-rock').style.background = 'rgba(0,242,255,0.4)';
        }
        
        // Detect up tilt (arms pull) - completes arm cycle
        if (pitchDiff > 2 && flyRockPhase === "down") {
            flyRockPhase = "up";
            flyRightArm = true;
            document.getElementById('fly-rock').style.background = 'rgba(255,140,0,0.4)';
        }
        
        lastFlyPitch = pitch;
    }

    function butterflyKick(side) {
        if (!isRacing || isCramped) return;
        
        const lBtn = document.getElementById('fly-l-kick');
        const rBtn = document.getElementById('fly-r-kick');
        
        if (side === 'L') {
            flyLeftKick = true;
            lBtn.classList.add('active-btn');
        } else {
            flyRightKick = true;
            rBtn.classList.add('active-btn');
        }
        
        // Check if full stroke complete
        if (flyLeftArm && flyRightArm && flyLeftKick && flyRightKick) {
            pDist += 1.2;
            
            flyLeftArm = false; flyRightArm = false; flyLeftKick = false; flyRightKick = false;
            flyRockPhase = "neutral";
            lBtn.classList.remove('active-btn');
            rBtn.classList.remove('active-btn');
            document.getElementById('fly-rock').style.background = '';
            
            checkRaceEnd();
        }
    }

    function butterflyWallTouch() {
        const nearWall = pDist % 100 > 88 && pDist % 100 < 99;
        if (!nearWall) return;
        
        const lBtn = document.getElementById('fly-l-kick');
        const rBtn = document.getElementById('fly-r-kick');
        
        // Forgiving: if both buttons pressed recently (both have active class)
        if (lBtn.classList.contains('active-btn') && rBtn.classList.contains('active-btn')) {
            pDist += 5;
            
            const sig = document.getElementById('signal');
            sig.innerText = "TWO-HAND TOUCH!";
            sig.style.color = "lime";
            setTimeout(() => { sig.innerText = ""; }, 500);
        }
    }

    function handleBackstrokeRocking(e) {
        if (!isRacing || currentStroke !== "backstroke" || !e.accelerationIncludingGravity) return;
        
        const tilt = e.accelerationIncludingGravity.x || 0;
        const tiltChange = Math.abs(tilt - lastTilt);
        
        if (tiltChange > 1.5) {
            backstrokeSpeed = 0.4; // Reduced from 0.7
        } else {
            backstrokeSpeed *= 0.92;
        }
        
        lastTilt = tilt;
        pDist += backstrokeSpeed;
        checkRaceEnd();
    }

    function backstrokeKick(side) {
        if (!isRacing || isCramped) return;
        
        const lBtn = document.getElementById('back-l-kick');
        const rBtn = document.getElementById('back-r-kick');
        
        if (side === 'L') {
            lBtn.classList.add('active-btn');
            rBtn.classList.remove('active-btn');
        } else {
            rBtn.classList.add('active-btn');
            lBtn.classList.remove('active-btn');
        }
        
        if (justTurned && kicksAfterTurn < 5) {
            if (lBtn.classList.contains('active-btn') && rBtn.classList.contains('active-btn')) {
                pDist += 1.5;
                kicksAfterTurn++;
                
                const sig = document.getElementById('signal');
                sig.innerText = "BUTTERFLY KICK!";
                sig.style.color = "cyan";
                setTimeout(() => { sig.innerText = ""; }, 400);
            } else {
                pDist += 0.5;
            }
        } else {
            pDist += 0.5;
        }
        
        checkRaceEnd();
    }

    function handleBreaststrokeSlider(e) {
        if (!isRacing) return;
        
        const val = parseInt(e.target.value);
        
        if (val >= 95 && !sliderAtTop) {
            sliderAtTop = true;
        }
        
        if (val <= 5 && sliderAtTop && !sliderCycleComplete) {
            sliderCycleComplete = true;
            document.getElementById('breast-kick').style.background = 'lime';
            document.getElementById('breast-kick').style.color = '#000';
        }
        
        sliderPosition = val;
    }

    function breaststrokeKick() {
        if (!isRacing || isCramped || !sliderCycleComplete) return;
        
        pDist += 1.8; // Increased from 1.0
        
        sliderCycleComplete = false;
        sliderAtTop = false;
        document.getElementById('arm-slider').value = 0;
        document.getElementById('breast-kick').style.background = '';
        document.getElementById('breast-kick').style.color = '';
        
        checkRaceEnd();
    }

    function runSequence() {
        const sig = document.getElementById('signal');
        sig.innerText = "READY...";
        setTimeout(() => {
            sig.innerText = "SET...";
            window.addEventListener('devicemotion', handleFalseStart);
            setTimeout(() => {
                if (audioContext) {
                    const osc = audioContext.createOscillator();
                    osc.connect(audioContext.destination);
                    osc.frequency.value = 800;
                    osc.start();
                    osc.stop(audioContext.currentTime + 0.15);
                }
                
                sig.innerText = "GO! DIVE IN!";
                sig.style.color = "lime";
                window.removeEventListener('devicemotion', handleFalseStart);
                window.addEventListener('devicemotion', handleDiveIn);
                
            }, Math.random() * 3000 + 1000);
        }, 1500);
    }

    function handleFalseStart(e) {
        if (e.accelerationIncludingGravity && Math.abs(e.accelerationIncludingGravity.z) > 15) {
            window.removeEventListener('devicemotion', handleFalseStart);
            alert("FALSE START! DQ!"); 
            location.reload();
        }
    }

    function handleDiveIn(e) {
        if (hasDived || !e.accelerationIncludingGravity) return;
        
        const y = e.accelerationIncludingGravity.y || 0;
        const z = e.accelerationIncludingGravity.z || 0;
        const x = e.accelerationIncludingGravity.x || 0;
        
        if (Math.abs(y) > 3 || Math.abs(z - 9.8) > 4 || Math.abs(x) > 3) {
            hasDived = true;
            isRacing = true;
            startTime = performance.now();
            
            const sig = document.getElementById('signal');
            sig.innerText = "DIVE!";
            sig.style.color = "cyan";
            setTimeout(() => { sig.innerText = ""; sig.style.color = "yellow"; }, 800);
            
            window.removeEventListener('devicemotion', handleDiveIn);
            window.addEventListener('devicemotion', handleFlip);
            requestAnimationFrame(gameLoop);
        }
    }

    function handleFlip(e) {
        if (!isRacing || !e.rotationRate) return;
        
        const now = Date.now();
        if (now - lastFlipTime < 1000) return;
        
        const total = Math.abs(e.rotationRate.beta || 0) + Math.abs(e.rotationRate.gamma || 0) + Math.abs(e.rotationRate.alpha || 0);
        const nearWall = pDist % 100 > 88 && pDist % 100 < 99;
        
        if (total > 200 && nearWall) {
            lastFlipTime = now;
            pDist += 5;
            
            if (currentStroke === "backstroke") {
                justTurned = true;
                kicksAfterTurn = 0;
            }
            
            if (audioContext) {
                const osc = audioContext.createOscillator();
                osc.connect(audioContext.destination);
                osc.frequency.value = 600;
                osc.start();
                osc.stop(audioContext.currentTime + 0.1);
            }
            
            const sig = document.getElementById('signal');
            sig.innerText = "FLIP TURN! +5m";
            sig.style.color = "lime";
            setTimeout(() => { sig.innerText = ""; sig.style.color = "yellow"; }, 500);
        }
    }

    function triggerCramp() {
        isCramped = true; 
        sameCount = 0;
        document.getElementById('cramp-msg').style.display = 'block';
        
        if (audioContext) {
            const osc = audioContext.createOscillator();
            osc.connect(audioContext.destination);
            osc.frequency.value = 200;
            osc.start();
            osc.stop(audioContext.currentTime + 0.3);
        }
        
        setTimeout(() => { 
            isCramped = false; 
            document.getElementById('cramp-msg').style.display = 'none'; 
        }, 2500);
    }

    function checkRaceEnd() {
        if (currentEvent.stroke === "im") {
            const segmentLength = 200;
            const segmentComplete = pDist >= (imSegment + 1) * segmentLength;
            
            if (segmentComplete && imSegment < 3) {
                imSegment++;
                const strokes = ["butterfly", "backstroke", "breaststroke", "freestyle"];
                currentStroke = strokes[imSegment];
                
                window.removeEventListener('devicemotion', handleBackstrokeRocking);
                window.removeEventListener('devicemotion', handleButterflyRocking);
                
                setupControls(currentStroke);
                
                const sig = document.getElementById('signal');
                sig.innerText = `${currentStroke.toUpperCase()}!`;
                sig.style.color = "yellow";
                setTimeout(() => { sig.innerText = ""; }, 1500);
            }
        }
        
        if (pDist >= currentEvent.l * 100) endRace(true);
    }

    function gameLoop(t) {
        if (!isRacing) return;
        let elapsed = (t - startTime) / 1000;
        let m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        let s = (elapsed % 60).toFixed(2).padStart(5, '0');
        document.getElementById('stopwatch').innerText = `${m}:${s}`;

        let botBase = (100 * currentEvent.l) / currentEvent.t;
        let speedMult = (pDist > bDist + 6) ? 1.12 : 1.0;
        bDist += (botBase / 60) * speedMult;

        if (bDist >= currentEvent.l * 100) endRace(false);
        
        if (currentStroke === "butterfly") butterflyWallTouch();
        
        draw();
        requestAnimationFrame(gameLoop);
    }

    function draw() {
        const c = document.getElementById('poolCanvas'); 
        const ctx = c.getContext('2d');
        c.width = window.innerWidth; 
        c.height = window.innerHeight * 0.65;
        ctx.fillStyle = "#0055aa"; 
        ctx.fillRect(0, 0, c.width, c.height);
        
        ctx.strokeStyle = "white"; 
        ctx.setLineDash([10, 20]);
        ctx.beginPath(); 
        ctx.moveTo(c.width / 2, 0); 
        ctx.lineTo(c.width / 2, c.height); 
        ctx.stroke();

        const getY = (d) => {
            let p = d % 100; 
            let l = Math.floor(d / 100);
            let y = (p / 100) * (c.height - 100) + 50;
            return (l % 2 === 0) ? y : c.height - y;
        };

        ctx.save(); 
        ctx.translate(c.width * 0.25, getY(bDist));
        if (Math.floor(bDist / 100) % 2 !== 0) ctx.rotate(Math.PI);
        ctx.font = "40px Arial"; 
        ctx.fillText("üèä", -20, 20); 
        ctx.restore();

        ctx.save(); 
        ctx.translate(c.width * 0.75, getY(pDist));
        if (Math.floor(pDist / 100) % 2 !== 0) ctx.rotate(Math.PI);
        ctx.font = "50px Arial"; 
        ctx.fillText("ü¶à", -25, 25); 
        ctx.restore();
    }

    function endRace(win) {
        isRacing = false;
        window.removeEventListener('devicemotion', handleFlip);
        window.removeEventListener('devicemotion', handleBackstrokeRocking);
        window.removeEventListener('devicemotion', handleButterflyRocking);
        
        // Calculate final time
        const elapsed = (performance.now() - startTime) / 1000;
        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toFixed(2).padStart(5, '0');
        finalTime = `${m}:${s}`;
        
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';
        
        if (win) {
            document.getElementById('win-lab').style.display = 'flex';
            document.getElementById('loss-area').style.display = 'none';
        } else {
            document.getElementById('win-lab').style.display = 'none';
            document.getElementById('loss-area').style.display = 'block';
            document.getElementById('legend-final-name').innerText = `${currentEvent.n} ${currentEvent.flag}`;
        }
    }

    // ===== WHEATIES BOX PHOTO FEATURE =====
    
    async function startWheaties() {
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('wheaties-screen').style.display = 'flex';
        
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'user' } 
            });
            document.getElementById('camera-video').srcObject = cameraStream;
        } catch (error) {
            alert('Camera access denied. Please enable camera permissions.');
            cancelWheaties();
        }
    }

    function capturePhoto() {
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('photo-canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas to portrait Wheaties box dimensions
        canvas.width = 600;
        canvas.height = 900;
        
        // Draw Wheaties box design
        ctx.fillStyle = '#ff8c00';
        ctx.fillRect(0, 0, 600, 900);
        
        // Wheaties logo area
        ctx.fillStyle = '#ff6347';
        ctx.font = 'bold 80px Arial';
        ctx.fillText('Wheaties', 150, 100);
        
        // Event name
        ctx.fillStyle = '#00f2ff';
        ctx.font = 'bold 40px Arial';
        ctx.fillText(currentEvent.eventName.toUpperCase(), 80, 180);
        
        // Time subtitle
        ctx.fillStyle = '#000';
        ctx.font = '30px Arial';
        ctx.fillText(`TIME: ${finalTime}`, 180, 230);
        
        // Draw captured photo
        ctx.save();
        ctx.translate(300, 550);
        
        // Draw photo in circle/portrait area
        const photoSize = 400;
        ctx.beginPath();
        ctx.rect(-200, -200, photoSize, photoSize);
        ctx.clip();
        ctx.drawImage(video, -200, -200, photoSize, photoSize);
        ctx.restore();
        
        // Draw mustache overlay
        ctx.font = '80px Arial';
        ctx.fillText('üë®', 260, 620);
        
        // Medal overlay
        ctx.font = '60px Arial';
        ctx.fillText('ü•áü•áü•á', 200, 750);
        
        // Bottom text
        ctx.fillStyle = '#000';
        ctx.font = 'bold 25px Arial';
        ctx.fillText('1972 OLYMPICS SWIM LEGEND', 100, 850);
        
        // Stop camera
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        
        // Show preview
        document.getElementById('camera-container').classList.add('hidden');
        document.getElementById('preview-container').classList.remove('hidden');
    }

    function saveWheaties() {
        const canvas = document.getElementById('photo-canvas');
        
        // Convert to blob and download
        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wheaties-${currentEvent.eventName}-${finalTime}.png`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Wheaties box saved! Check your downloads.');
            location.reload();
        });
    }

    function retakePhoto() {
        document.getElementById('preview-container').classList.add('hidden');
        document.getElementById('camera-container').classList.remove('hidden');
        startWheaties();
    }

    function cancelWheaties() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
        location.reload();
    }
</script>
</body>
</html>
